name: Tests (fork, multi-platform + ezmon NetDB)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NO_AT_BRIDGE: 1  # Necessary for GTK3 interactive test
  OPENBLAS_NUM_THREADS: 1
  PYTHONFAULTHANDLER: 1
  # NetDB configuration - direct server communication
  TESTMON_NET_ENABLED: "true"
  TESTMON_SERVER: "https://ezmon.aloiz.ch"
  TESTMON_AUTH_TOKEN: ${{ secrets.EZMON_AUTH_TOKEN }}

jobs:
  test:
    name: "Python ${{ matrix.python-version }} on ${{ matrix.os }} (ezmon)"
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS variants (matching upstream)
          - os: macos-14   # Apple Silicon
            python-version: '3.11'
          - os: macos-14
            python-version: '3.12'
          - os: macos-15   # Apple Silicon
            python-version: '3.13'
          # Linux variants (matching upstream)
          - os: ubuntu-22.04
            python-version: '3.12'
          - os: ubuntu-24.04-arm   # ARM64 Linux
            python-version: '3.12'

    env:
      # NetDB identifiers
      REPO_ID: ${{ github.repository }}
      JOB_ID: "${{ matrix.os }}-py${{ matrix.python-version }}"
      RUN_ID: ${{ github.run_id }}

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      # ===== OS-SPECIFIC PACKAGE INSTALLATION =====

      - name: Install OS packages (Linux)
        if: runner.os == 'Linux'
        run: |
          echo 'Acquire::Retries "3";' | sudo tee /etc/apt/apt.conf.d/80-retries
          sudo apt-get update -yy
          sudo apt-get install -yy --no-install-recommends \
            ccache \
            cm-super \
            dvipng \
            fonts-freefont-otf \
            fonts-noto-cjk \
            fonts-wqy-zenhei \
            gir1.2-gtk-3.0 \
            gir1.2-gtk-4.0 \
            graphviz \
            inkscape \
            language-pack-de \
            libcairo2 \
            libcairo2-dev \
            libffi-dev \
            libgeos-dev \
            libnotify4 \
            libsdl2-2.0-0 \
            libxkbcommon-x11-0 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            lmodern \
            ninja-build \
            pkg-config \
            qtbase5-dev \
            texlive-fonts-recommended \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-latex-recommended \
            texlive-luatex \
            texlive-pictures \
            texlive-xetex \
            ffmpeg \
            poppler-utils
          # libgirepository package name differs between Ubuntu versions
          if [[ "${{ matrix.os }}" == ubuntu-22.04 ]]; then
            sudo apt-get install -yy --no-install-recommends libgirepository1.0-dev
          else  # ubuntu-24.04*
            sudo apt-get install -yy --no-install-recommends libgirepository-2.0-dev
          fi

      - name: Install OS packages (macOS)
        if: runner.os == 'macOS'
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
        run: |
          # Workaround for Homebrew Python conflicts
          # https://github.com/actions/runner-images/issues/9966
          for python_package in $(brew list | grep python@ || true); do
            brew unlink ${python_package} || true
            brew link --overwrite ${python_package} || true
          done
          # Workaround for https://github.com/actions/runner-images/issues/10984
          brew uninstall --ignore-dependencies --force pkg-config@0.29.2 || true
          # Install required packages (matching upstream)
          brew install ccache ffmpeg ghostscript gobject-introspection gtk4 imagemagick ninja || true
          brew install --cask inkscape || true

      # ===== CACHING =====

      - name: Cache pip (Linux)
        uses: actions/cache@v4
        if: runner.os == 'Linux'
        with:
          path: ~/.cache/pip
          key: ${{ matrix.os }}-py${{ matrix.python-version }}-pip-${{ hashFiles('requirements/*/*.txt') }}
          restore-keys: |
            ${{ matrix.os }}-py${{ matrix.python-version }}-pip-

      - name: Cache pip (macOS)
        uses: actions/cache@v4
        if: runner.os == 'macOS'
        with:
          path: ~/Library/Caches/pip
          key: ${{ matrix.os }}-py${{ matrix.python-version }}-pip-${{ hashFiles('requirements/*/*.txt') }}
          restore-keys: |
            ${{ matrix.os }}-py${{ matrix.python-version }}-pip-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
          key: ${{ matrix.os }}-py${{ matrix.python-version }}-ccache-${{ hashFiles('src/*') }}
          restore-keys: |
            ${{ matrix.os }}-py${{ matrix.python-version }}-ccache-

      # ===== PYTHON DEPENDENCIES =====

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel

          # Core build + runtime deps (matching upstream)
          python -m pip install --upgrade \
            'contourpy>=1.0.1' cycler fonttools kiwisolver importlib_resources \
            packaging pillow 'pyparsing!=3.1.0' python-dateutil setuptools-scm \
            'meson-python>=0.13.1' 'pybind11>=2.13.2'

          # Test requirements
          python -m pip install -r requirements/testing/all.txt

          # Sphinx for sphinxext tests
          python -m pip install --upgrade 'sphinx!=6.1.2'

          # Test runner + ezmon (our fork with NetDB support)
          python -m pip install pytest pytest-xdist pytest-timeout
          python -m pip install --no-cache-dir git+https://github.com/andreas16700/pytest-testmon.git@main

      - name: Install GUI toolkits (Linux)
        if: runner.os == 'Linux'
        run: |
          # GUI toolkits - don't fail if they can't be installed
          python -m pip install --upgrade pycairo 'cairocffi>=0.8' 'PyGObject<3.52.0' || true
          python -c 'import gi; gi.require_version("Gtk", "4.0"); from gi.repository import Gtk' && \
            echo 'PyGObject 4 is available' || echo 'PyGObject 4 is not available'
          python -c 'import gi; gi.require_version("Gtk", "3.0"); from gi.repository import Gtk' && \
            echo 'PyGObject 3 is available' || echo 'PyGObject 3 is not available'

          # Qt toolkits - PyQt5 doesn't have ARM wheels
          if [[ "${{ matrix.os }}" != 'ubuntu-24.04-arm' ]]; then
            python -m pip install --upgrade --only-binary :all: pyqt5 || true
            python -c 'import PyQt5.QtCore' && echo 'PyQt5 is available' || echo 'PyQt5 is not available'
          fi

          python -m pip install --upgrade --only-binary :all: pyqt6 || true
          python -c 'import PyQt6.QtCore' && echo 'PyQt6 is available' || echo 'PyQt6 is not available'

          python -m pip install --upgrade --only-binary :all: pyside6 || true
          python -c 'import PySide6.QtCore' && echo 'PySide6 is available' || echo 'PySide6 is not available'

          # wxPython - skip on ARM (no wheels available)
          if [[ "${{ matrix.os }}" != 'ubuntu-24.04-arm' ]]; then
            python -m pip install --upgrade --only-binary :all: \
              -f "https://extras.wxpython.org/wxPython4/extras/linux/gtk3/${{ matrix.os }}" \
              wxPython || true
            python -c 'import wx' && echo 'wxPython is available' || echo 'wxPython is not available'
          fi

      - name: Install GUI toolkits (macOS)
        if: runner.os == 'macOS'
        run: |
          # Qt toolkits on macOS
          python -m pip install --upgrade --only-binary :all: pyqt6 || true
          python -c 'import PyQt6.QtCore' && echo 'PyQt6 is available' || echo 'PyQt6 is not available'

          python -m pip install --upgrade --only-binary :all: pyside6 || true
          python -c 'import PySide6.QtCore' && echo 'PySide6 is available' || echo 'PySide6 is not available'

      # ===== BUILD MATPLOTLIB =====

      - name: Install Matplotlib (editable, Agg backend)
        run: |
          python -m pip install --no-deps --no-build-isolation --verbose \
            --config-settings=setup-args="-DrcParams-backend=Agg" \
            --editable .[dev]

      # ===== DEBUG INFO =====

      - name: Debug Python + ezmon setup
        run: |
          echo "=== Python Environment ==="
          python -V
          python -c "import sys; print('Executable:', sys.executable)"

          echo "=== ezmon Configuration ==="
          python -c "import ezmon; print('ezmon version:', ezmon.TESTMON_VERSION)"
          echo "NetDB enabled: $TESTMON_NET_ENABLED"
          echo "Server: $TESTMON_SERVER"
          echo "Repo ID: $REPO_ID"
          echo "Job ID: $JOB_ID"

          echo "=== Matplotlib Info ==="
          python -c "import matplotlib; print('matplotlib version:', matplotlib.__version__)"
          python -c "import matplotlib; print('matplotlib location:', matplotlib.__file__)"

      # ===== RUN TESTS =====

      - name: Run tests (pytest + ezmon NetDB)
        run: |
          python -m pytest \
            --ezmon --ezmon-no-reorder \
            -rfEsXR -n auto \
            --timeout=600 --maxfail=50 \
            --durations=25 \
            --color=yes \
            -v --tb=short

      # ===== ARTIFACTS ON FAILURE =====

      - name: Upload result images on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: "${{ matrix.python-version }}-${{ matrix.os }}-result-images"
          path: ./result_images
          if-no-files-found: ignore
